define(["exports","esri/tasks/BufferParameters","esri/tasks/GeometryService","esri/SpatialReference","esri/geometry/Polygon","esri/request","esri/config","dojo/Deferred","dojo/promise/all"],function(e,r,t,n,o,a,i,u,s){"use strict";function R(e){return e&&e.__esModule?e:{"default":e}}function E(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _(e,r,t){var n=new A["default"];return(0,I["default"])({BUFFER:H(e,t||v.RADIUS),INDO:X(e)}).then(function(t){var o=t.BUFFER[0];F=t.INDO,(0,I["default"])({HISTORIC:oe(o),FUTURE:ae(o)}).then(function(t){n.resolve(ie(t,e,r))})}),n}Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=_;var c=R(r),S=R(t),l=R(n),m=R(o),d=R(a),f=R(i),A=R(u),I=R(s),T=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},O=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),v={RADIUS:50,DENSITY:30,TIMEOUT:45e3,PIXEL_SIZE:100,FUTURE_YEAR_COUNT:2,CONTENT_FORMAT:"json",HISTORIC_YEAR_END_INDEX:11,HISTORIC_YEAR_START_INDEX:8,GEOMETRY_POINT:"esriGeometryPoint",GEOMETRY_POLYGON:"esriGeometryPolygon"},g={1:"low",2:"medium low",3:"medium",4:"medium high",5:"high"},p={ADD:1,MULTIPLY:3},h={mosaic:function(e){return{mosaicMethod:"esriMosaicLockRaster",mosaicOperation:"MT_FIRST",lockRasterIds:[e],ascending:!0}},arithmetic:function(e,r,t){return{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:e,Raster2:r,Operation:t}}},remap:function(e,r,t){return{rasterFunction:"Remap",rasterFunctionArguments:{InputRanges:r,OutputValues:t,Raster:e,AllowUnmatched:!1}}}},P={FIRES_RASTER_URL:"http://gis-gfw.wri.org/arcgis/rest/services/image_services/annual_fires/ImageServer",IMAGE_SERVICE_URL:"http://gis-gfw.wri.org/arcgis/rest/services/image_services/analysis/ImageServer",GEOMETRY_SERVICE_URL:"http://gis-gfw.wri.org/arcgis/rest/services/Utilities/Geometry/GeometryServer",BOUNDARY_SERVICE_URL:"http://gis-potico.wri.org/arcgis/rest/services/CommoditiesAnalyzer/mapfeatures/MapServer/6",CANOPY_DENSITY_REMAP:h.remap("$520",[0,v.DENSITY,v.DENSITY,101],[0,1]),TREE_COVER_LOSS:{id:"$530",bounds:[1,14]},PRIMARY_FOREST:{id:"$519",bounds:[1,2]},PEAT:{id:"$8",bounds:[0,1]},PROTECTED_AREA:{id:"$10",bounds:[0,1]},CARBON:{id:"$524",bounds:[0,1],remap:h.remap("$524",[0,21,21,1e3],[0,1])},TREE_COVER_EXTENT:{id:"$520"},INTACT_FOREST_LANDSCAPE:{id:"$9"},FIRES:{PIXEL_SIZE:890.5559263,ID_09:1,ID_10:2,ID_11:3,ID_12:4,ID_13:5,ID_14:6,ID_15:7}},L={CARBON_AREA:{type:"percent",mean:97.4844264320578,std_dev:5.80679891475239},CARBON_LOSS:{type:"number",mean:56217.0225558689,std_dev:31809.0317428085},FIRE_ACTIVITY_FUTURE:{type:"number",mean:.000460204626986657,std_dev:.000766697137551235},FIRE_ACTIVITY_HISTORIC:{type:"number",mean:.000286715094002202,std_dev:.000333914715653048},WDPA_AREA:{type:"percent",mean:7.0943707179449,std_dev:8.79476646550044},WDPA_LOSS:{type:"number",mean:1110.91306737362,std_dev:2623.59393123987},PEAT_AREA:{type:"percent",mean:9.89270971142025,std_dev:12.6404304366422},PEAT_LOSS:{type:"number",mean:11008.3641323945,std_dev:19868.2264242601},PRIMARY_FOREST_AREA:{type:"percent",mean:12.1994422435213,std_dev:16.6663916771035},PRIMARY_FOREST_LOSS:{type:"number",mean:12023.9646408868,std_dev:22124.4048058646},TREE_COVER_FUTURE_RATE:{type:"number",mean:9458.15644847216,std_dev:4572.67100416795},TREE_COVER_LOSS_RATE:{type:"number",mean:14139.6008983245,std_dev:7936.63160196133}},C=void 0,y=void 0,F=void 0,U=new S["default"](P.GEOMETRY_SERVICE_URL);f["default"].defaults.io.corsEnabledServers.push("gis-gfw.wri.org"),f["default"].defaults.io.corsEnabledServers.push("gis-potico.wri.org");var N=function(e){var r=e.histograms,t=e.noSlice,n=r&&1===r.length?r[0].counts:[];return t?n:n.slice(1)},k=function(e){return parseInt(e.replace(/\$/,""))},Y=function(e,r){var t=e/r*100;return t>100?100:t},D=function(e,r,t){return(e-r)/t},M=function(e){var r=void 0;return r=e>=1?5:e>=.5&&.99>=e?4:e>=-.49&&.49>=e?3:e>=-.99&&-.49>=e?2:1,{score:r,zScore:e,rank:g[r]}},b=function(){return{score:1,zScore:-1,rank:g[1]}},z=function(e,r){var t=e*r,n=void 0;return n=t>=21?5:t>=16&&20>=t?4:t>=11&&15>=t?3:t>=5&&10>=t?2:1,g[n]},w=function(e){for(var r=0,t=v.HISTORIC_YEAR_START_INDEX;t<=v.HISTORIC_YEAR_END_INDEX;t++)e[t]&&(r+=e[t]);return r},V=function(e){for(var r=[],t=v.FUTURE_YEAR_COUNT;t>0;t--)r.push(e[e.length-t]);return r.reduce(function(e,r){return e+r},0)/r.length},B=function(e){for(var r=[],t=v.HISTORIC_YEAR_START_INDEX;t<=v.HISTORIC_YEAR_END_INDEX;t++)r.push(e[t]);return r.reduce(function(e,r){return e+r},0)/r.length},G=function(){function e(r,t){E(this,e),this.fromBounds=function(e){for(var r=[],t=e[1],n=e[0];t>=n;n++)r.push(n);return r},this.A=this.fromBounds(r),this.B=this.fromBounds(t)}return O(e,[{key:"encode",value:function(e,r){return this.B.length*e+r}},{key:"decode",value:function(e){var r=e%this.B.length,t=(e-r)/this.B.length;return[t,r]}},{key:"getSimpleRule",value:function(e,r){var t=P.CANOPY_DENSITY_REMAP,n=h.arithmetic(t,h.arithmetic(e,r,p.MULTIPLY),p.MULTIPLY);return n.rasterFunctionArguments.Raster2.outputPixelType="U8",n}},{key:"getRule",value:function(e,r){var t=h.remap(e,[this.A[0],this.A[this.A.length-1]+1],[this.B.length]),n=P.CANOPY_DENSITY_REMAP,o=h.arithmetic(n,h.arithmetic(h.arithmetic(t,e,p.MULTIPLY),r,p.ADD),p.MULTIPLY);return o.rasterFunctionArguments.Raster2.outputPixelType="U8",o}}]),e}(),x=function(e,r){return r.geometry&&(r.geometry=JSON.stringify(r.geometry)),r.renderingRule&&(r.renderingRule=JSON.stringify(r.renderingRule)),r.mosaicRule&&(r.mosaicRule=JSON.stringify(r.mosaicRule)),r.geometryType=r.geometryType||v.GEOMETRY_POLYGON,r.pixelSize=r.pixelSize||v.PIXEL_SIZE,r.f=r.f||v.CONTENT_FORMAT,(0,d["default"])({url:e+"/computeHistograms",callbackParamName:"callback",timeout:v.TIMEOUT,content:r,handleAs:"json"},{usePost:!0})},X=function(e){var r=new A["default"],t={where:"ISO = 'IDN'",geometryType:v.GEOMETRY_POINT,geometry:JSON.stringify(e),returnGeometry:!1,outFields:[],f:"json"};return(0,d["default"])({url:P.BOUNDARY_SERVICE_URL+"/query",callbackParamName:"callback",timeout:v.TIMEOUT,content:t,handleAs:"json"},{usePost:!0}).then(function(e){r.resolve(e&&e.features&&e.features.length>0)}),r},j=function(e){var r=new A["default"],t={geometryType:v.GEOMETRY_POLYGON,spatialRel:"esriSpatialRelIntersects",geometry:JSON.stringify(e),returnGeometry:!0,outFields:[],outSR:54010,f:"json"};return(0,d["default"])({url:P.BOUNDARY_SERVICE_URL+"/query",callbackParamName:"callback",timeout:v.TIMEOUT,content:t,handleAs:"json"},{usePost:!0}).then(function(e){r.resolve(e.features)}),r},H=function(e,r){var t=new A["default"],n=new c["default"];return n.geometries=[e],n.distances=[r],n.unit=S["default"].UNIT_KILOMETER,n.outSpatialReference=new l["default"](54010),U.buffer(n,t.resolve,console.error),t},Z=function(e,r){var t=new A["default"];return U.intersect(e,r,t.resolve,console.error),t},$=function(e){if(y)return y;y=new A["default"];var r={areaUnit:'{"areaUnit": "esriHectares"}',calculationType:"preserveShape",sr:54010,f:"json"};return j(e).then(function(t){var n=t.map(function(e){return new m["default"](e.geometry)});Z(n,e).then(function(e){r.polygons=JSON.stringify(e),(0,d["default"])({url:P.GEOMETRY_SERVICE_URL+"/areasAndLengths",callbackParamName:"callback",timeout:v.TIMEOUT,content:r,handleAs:"json"},{usePost:!0}).then(function(e){y.resolve(e.areas.reduce(function(e,r){return e+r},0))})})}),y},J=function(e){if(C)return C;C=new A["default"];var r={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:h.arithmetic(P.CANOPY_DENSITY_REMAP,P.TREE_COVER_LOSS.id,p.MULTIPLY)};return x(P.IMAGE_SERVICE_URL,r).then(function(e){C.resolve(N({histograms:e.histograms}))}),C},W=function(e){var r=new A["default"],t=new G(P.TREE_COVER_LOSS.bounds,P.PRIMARY_FOREST.bounds),n=t.getRule(P.TREE_COVER_LOSS.id,P.PRIMARY_FOREST.id),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return x(P.IMAGE_SERVICE_URL,o).then(function(e){for(var n=t.A,o=t.B,a=N({histograms:e.histograms,noSlice:!0}),i=[],u=0;u<n.length;u++){for(var s=0,R=0;R<o.length;R++){var E=t.encode(n[u],o[R]);s+=a[E]||0}i.push(s)}r.resolve(i)}),r},q=function(e){var r=new A["default"],t=new G(P.TREE_COVER_LOSS.bounds,P.PEAT.bounds),n=t.getSimpleRule(P.TREE_COVER_LOSS.id,P.PEAT.id),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return x(P.IMAGE_SERVICE_URL,o).then(function(e){r.resolve(N({histograms:e.histograms}))}),r},K=function(e){var r=new A["default"],t=new G(P.TREE_COVER_LOSS.bounds,P.PROTECTED_AREA.bounds),n=t.getSimpleRule(P.TREE_COVER_LOSS.id,P.PROTECTED_AREA.id),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return x(P.IMAGE_SERVICE_URL,o).then(function(e){r.resolve(N({histograms:e.histograms}))}),r},Q=function(e){var r=new A["default"],t=new G(P.TREE_COVER_LOSS.bounds,P.CARBON.bounds),n=t.getRule(P.TREE_COVER_LOSS.id,P.CARBON.remap),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return x(P.IMAGE_SERVICE_URL,o).then(function(e){for(var n=t.A,o=t.B,a=N({histograms:e.histograms,noSlice:!0}),i=[],u=0;u<n.length;u++){for(var s=0,R=1;R<o.length;R++){var E=t.encode(n[u],o[R]);s+=a[E]||0}i.push(s)}r.resolve(i)}),r},ee=function(e,r){var t=new A["default"],n={geometry:r,pixelSize:v.PIXEL_SIZE,mosaicRule:h.mosaic(k(e))};return x(P.IMAGE_SERVICE_URL,n).then(function(e){if(e.histograms.length){var r=N({histograms:e.histograms});t.resolve(r.length?r.reduce(function(e,r){return e+r},0):0)}else t.resolve(0)},function(){t.resolve(0)}),t},re=function(e){var r=new A["default"],t={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:P.CARBON.remap};return x(P.IMAGE_SERVICE_URL,t).then(function(e){if(e.histograms.length){var t=N({histograms:e.histograms});r.resolve(t.length?t[0]:0)}else r.resolve(0)},function(){r.resolve(0)}),r},te=function(e){var r=new A["default"],t={geometry:e,pixelSize:P.FIRES.PIXEL_SIZE},n=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_09)}),o=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_10)}),a=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_11)}),i=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_12)});return(0,I["default"])([x(P.FIRES_RASTER_URL,n),x(P.FIRES_RASTER_URL,o),x(P.FIRES_RASTER_URL,a),x(P.FIRES_RASTER_URL,i)]).then(function(e){var t=e.map(function(e){var r=N({histograms:e.histograms,noSlice:!0});return r.reduce(function(e,r,t){return e+r*t},0)});r.resolve(t.reduce(function(e,r){return e+r},0)/t.length)}),r},ne=function(e){var r=new A["default"],t={geometry:e,pixelSize:P.FIRES.PIXEL_SIZE},n=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_13)}),o=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_14)});return(0,I["default"])([x(P.FIRES_RASTER_URL,n),x(P.FIRES_RASTER_URL,o)]).then(function(e){var t=e.map(function(e){var r=N({histograms:e.histograms,noSlice:!0});return r.reduce(function(e,r,t){return e+r*t},0)});r.resolve(t.reduce(function(e,r){return e+r},0)/t.length)}),r},oe=function(e){var r=new A["default"];return(0,I["default"])({AREA:$(e),LOSS:J(e),PRIMARY_FOREST:W(e),PEAT:q(e),PROTECTED_AREA:K(e),CARBON:Q(e),FIRE:te(e)}).then(function(e){var t=B(e.LOSS),n=w(e.PRIMARY_FOREST),o=w(e.PEAT),a=w(e.PROTECTED_AREA),i=w(e.CARBON),u=e.FIRE/e.AREA,s=t?M(D(t,L.TREE_COVER_LOSS_RATE.mean,L.TREE_COVER_LOSS_RATE.std_dev)):b(),R=n?M(D(n,L.PRIMARY_FOREST_LOSS.mean,L.PRIMARY_FOREST_LOSS.std_dev)):b(),E=o?M(D(o,L.PEAT_LOSS.mean,L.PEAT_LOSS.std_dev)):b(),_=a?M(D(a,L.WDPA_LOSS.mean,L.WDPA_LOSS.std_dev)):b(),c=i?M(D(i,L.CARBON_LOSS.mean,L.CARBON_LOSS.std_dev)):b(),S=u?M(D(u,L.FIRE_ACTIVITY_HISTORIC.mean,L.FIRE_ACTIVITY_HISTORIC.std_dev)):b();r.resolve({primary_forest:T({amount:n},R),peat:T({amount:o},E),protected_areas:T({amount:a},_),carbon:T({amount:i},c),tree_cover:T({amount:t},s),fire:T({amount:u},S)})}),r},ae=function(e){var r=new A["default"];return(0,I["default"])({AREA:$(e),LOSS_RATE:J(e),PRIMARY_FOREST:ee(P.PRIMARY_FOREST.id,e),PEAT:ee(P.PEAT.id,e),PROTECTED_AREA:ee(P.PROTECTED_AREA.id,e),CARBON:re(e),IFL:ee(P.INTACT_FOREST_LANDSCAPE.id,e),FIRE:ne(e)}).then(function(e){var t=V(e.LOSS_RATE,v.FUTURE_YEAR_COUNT),n=Y(F?e.PRIMARY_FOREST:e.IFL,e.AREA),o=Y(e.PEAT,e.AREA),a=Y(e.PROTECTED_AREA,e.AREA),i=Y(e.CARBON,e.AREA),u=e.FIRE/e.AREA,s=n?M(D(n,L.PRIMARY_FOREST_AREA.mean,L.PRIMARY_FOREST_AREA.std_dev)):b(),R=o?M(D(o,L.PEAT_AREA.mean,L.PEAT_AREA.std_dev)):b(),E=a?M(D(a,L.WDPA_AREA.mean,L.WDPA_AREA.std_dev)):b(),_=i?M(D(i,L.CARBON_AREA.mean,L.CARBON_AREA.std_dev)):b(),c=t?M(D(t,L.TREE_COVER_FUTURE_RATE.mean,L.TREE_COVER_FUTURE_RATE.std_dev)):b(),S=u?M(D(u,L.FIRE_ACTIVITY_FUTURE.mean,L.FIRE_ACTIVITY_FUTURE.std_dev)):b();r.resolve({primary_forest:T({amount:n},s),peat:T({amount:o},R),protected_areas:T({amount:a},E),carbon:T({amount:i},_),tree_cover:T({amount:t},c),fire:T({amount:u},S)})}),r},ie=function(e,r,t){var n=e.HISTORIC,o=e.FUTURE,a=0===o.tree_cover.zScore&&0===n.tree_cover.zScore,i=0===o.primary_forest.zScore&&0===n.primary_forest.zScore,u=0===o.peat.zScore&&0===n.peat.zScore,s=0===o.protected_areas.zScore&&0===n.protected_areas.zScore,R=0===o.carbon.zScore&&0===n.carbon.zScore,E=0===o.fire.zScore&&0===n.fire.zScore,_=(n.tree_cover.zScore+n.primary_forest.zScore+n.peat.zScore+n.protected_areas.zScore+n.carbon.zScore+n.fire.zScore)/6,c=(o.tree_cover.zScore+o.primary_forest.zScore+o.peat.zScore+o.protected_areas.zScore+o.carbon.zScore+o.fire.zScore)/6,S=M(_),l=M(c),m={};return r.getLatitude&&(m.latitude=r.getLatitude().toFixed(4)),r.getLongitude&&(m.longitude=r.getLongitude().toFixed(4)),T({tree_cover:{extent:{amount:o.tree_cover.amount,rank:o.tree_cover.rank},loss:{amount:n.tree_cover.amount,rank:n.tree_cover.rank},risk:a?b().rank:M((o.tree_cover.zScore+n.tree_cover.zScore)/2).rank},primary_forest:{extent:{amount:o.primary_forest.amount,rank:o.primary_forest.rank},loss:{amount:n.primary_forest.amount,rank:n.primary_forest.rank},risk:i?b().rank:M((o.primary_forest.zScore+n.primary_forest.zScore)/2).rank},peat:{extent:{amount:o.peat.amount,rank:o.peat.rank},loss:{amount:n.peat.amount,rank:n.peat.rank},risk:u?b().rank:M((o.peat.zScore+n.peat.zScore)/2).rank},protected_areas:{extent:{amount:o.protected_areas.amount,rank:o.protected_areas.rank},loss:{amount:n.protected_areas.amount,rank:n.protected_areas.rank},risk:s?b().rank:M((o.protected_areas.zScore+n.protected_areas.zScore)/2).rank},carbon:{extent:{amount:o.carbon.amount,rank:o.carbon.rank},loss:{amount:n.carbon.amount,rank:n.carbon.rank},risk:R?b().rank:M((o.carbon.zScore+n.carbon.zScore)/2).rank},fire:{extent:{amount:o.fire.amount,rank:o.fire.rank},loss:{amount:n.fire.amount,rank:n.fire.rank},risk:E?b().rank:M((o.fire.zScore+n.fire.zScore)/2).rank},historic_loss:S.rank,future_risk:l.rank,priority_level:z(S.score,l.score),mill_name:t||""},m)}});