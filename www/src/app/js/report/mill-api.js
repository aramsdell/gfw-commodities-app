define(["exports","esri/tasks/BufferParameters","esri/tasks/GeometryService","esri/SpatialReference","esri/request","esri/config","dojo/Deferred","dojo/promise/all"],function(e,r,t,n,a,o,i,s){"use strict";function u(e){return e&&e.__esModule?e:{"default":e}}function R(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function E(e,r,t){var n=new d["default"];return(0,A["default"])({BUFFER:B(e,t||T.RADIUS),INDO:x(e)}).then(function(e){var t=e.BUFFER[0];L=e.INDO,(0,A["default"])({HISTORIC:Q(t),FUTURE:ee(t)}).then(function(e){n.resolve(re(e,r))})}),n}Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=E;var _=u(r),c=u(t),S=u(n),m=u(a),l=u(o),d=u(i),A=u(s),f=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},I=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),T={RADIUS:50,DENSITY:30,TIMEOUT:3e4,PIXEL_SIZE:100,FUTURE_YEAR_COUNT:3,CONTENT_FORMAT:"json",HISTORIC_YEAR_END_INDEX:11,HISTORIC_YEAR_START_INDEX:8,GEOMETRY_POINT:"esriGeometryPoint",GEOMETRY_TYPE:"esriGeometryPolygon"},O={1:"low",2:"medium low",3:"medium",4:"medium high",5:"high"},v={ADD:1,MULTIPLY:3},p={mosaic:function(e){return{mosaicMethod:"esriMosaicLockRaster",mosaicOperation:"MT_FIRST",lockRasterIds:[e],ascending:!0}},arithmetic:function(e,r,t){return{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:e,Raster2:r,Operation:t}}},remap:function(e,r,t){return{rasterFunction:"Remap",rasterFunctionArguments:{InputRanges:r,OutputValues:t,Raster:e,AllowUnmatched:!1}}}},g={FIRES_RASTER_URL:"http://gis-gfw.wri.org/arcgis/rest/services/image_services/annual_fires/ImageServer",IMAGE_SERVICE_URL:"http://gis-gfw.wri.org/arcgis/rest/services/image_services/analysis/ImageServer",GEOMETRY_SERVICE_URL:"http://gis-gfw.wri.org/arcgis/rest/services/Utilities/Geometry/GeometryServer",BOUNDARY_SERVICE_URL:"http://gis-potico.wri.org/arcgis/rest/services/CommoditiesAnalyzer/mapfeatures/MapServer/6",CANOPY_DENSITY_REMAP:p.remap("$520",[0,T.DENSITY,T.DENSITY,101],[0,1]),TREE_COVER_LOSS:{id:"$530",bounds:[1,14]},PRIMARY_FOREST:{id:"$519",bounds:[1,2]},PEAT:{id:"$8",bounds:[0,1]},PROTECTED_AREA:{id:"$10",bounds:[0,1]},CARBON:{id:"$524",bounds:[0,2],remap:p.remap("$524",[0,20,20,80,80,1e3],[0,1,2])},TREE_COVER_EXTENT:{id:"$520"},INTACT_FOREST_LANDSCAPE:{id:"$9"},FIRES:{PIXEL_SIZE:890.5559263,ID_09:1,ID_10:2,ID_11:3,ID_12:4,ID_13:5,ID_14:6,ID_15:7}},h={CARBON_AREA:{type:"percent",mean:97.6,std_dev:4.6},CARBON_LOSS:{type:"percent",mean:20.242,std_dev:9.526},FIRE_ACTIVITY_FUTURE:{type:"rate",mean:-14.107,std_dev:387.391},FIRE_ACTIVITY_HISTORIC:{type:"rate",mean:.286715094,std_dev:.333914716},WDPA_AREA:{type:"percent",mean:7.0943707,std_dev:8.7947665},WDPA_LOSS:{type:"percent",mean:3.8825311,std_dev:8.45626926},PEAT_AREA:{type:"percent",mean:9.8927097,std_dev:12.6404304},PEAT_LOSS:{type:"percent",mean:.3941634139,std_dev:.703893798},PRIMARY_FOREST_AREA:{type:"percent",mean:12.1994422,std_dev:16.6663917},PRIMARY_FOREST_LOSS:{type:"percent",mean:.4083326564,std_dev:.7294470828},TREE_COVER_FUTURE_RATE:{type:"rate",mean:2879.146877,std_dev:4281.066332},TREE_COVER_LOSS_RATE:{type:"rate",mean:20.33717183,std_dev:9.556807527}},P=void 0,C=void 0,L=void 0;l["default"].defaults.io.corsEnabledServers.push("gis-gfw.wri.org"),l["default"].defaults.io.corsEnabledServers.push("gis-potico.wri.org");var y=function(e){var r=e.histograms,t=e.noSlice,n=r&&1===r.length?r[0].counts:[];return t?n:n.slice(1)},F=function(e){return parseInt(e.replace(/\$/,""))},U=function(e,r){var t=e/r*100;return t>100?100:t},k=function(e,r,t){return(e-r)/t},N=function(e){var r=void 0;return r=e>=1?5:e>=.5&&.99>=e?4:e>=-.49&&.49>=e?3:e>=-.99&&-.49>=e?2:1,{score:r,zScore:e,rank:O[r]}},D=function(){return{score:1,zScore:0,rank:O[1]}},Y=function(e,r){var t=e*r,n=void 0;return n=t>=21?5:t>=16&&20>=t?4:t>=11&&15>=t?3:t>=5&&10>=t?2:1,O[n]},M=function(e){var r=0;return r+=e[8]||0,r+=e[9]||0,r+=e[10]||0,r+=e[11]||0,r/4},z=function(e,r){if(e.length<r)return 0;for(var t=[],n=1;r>n;n++)t.push(e[e.length-n]-e[e.length-(1+n)]);return t.reduce(function(e,r){return e+r},0)/t.length},b=function(e){for(var r=[],t=T.HISTORIC_YEAR_START_INDEX;t<T.HISTORIC_YEAR_END_INDEX;t++)r.push(e[t]-e[t+1]);return r.reduce(function(e,r){return e+r},0)/r.length},w=function(){function e(r,t){R(this,e),this.fromBounds=function(e){for(var r=[],t=e[1],n=e[0];t>=n;n++)r.push(n);return r},this.A=this.fromBounds(r),this.B=this.fromBounds(t)}return I(e,[{key:"encode",value:function(e,r){return this.B.length*e+r}},{key:"decode",value:function(e){var r=e%this.B.length,t=(e-r)/this.B.length;return[t,r]}},{key:"getSimpleRule",value:function(e,r){var t=g.CANOPY_DENSITY_REMAP,n=p.arithmetic(t,p.arithmetic(e,r,v.MULTIPLY),v.MULTIPLY);return n.rasterFunctionArguments.Raster2.outputPixelType="U8",n}},{key:"getRule",value:function(e,r){var t=p.remap(e,[this.A[0],this.A[this.A.length-1]+1],[this.B.length]),n=g.CANOPY_DENSITY_REMAP,a=p.arithmetic(n,p.arithmetic(p.arithmetic(t,e,v.MULTIPLY),r,v.ADD),v.MULTIPLY);return a.rasterFunctionArguments.Raster2.outputPixelType="U8",a}}]),e}(),V=function(e,r){return r.geometry&&(r.geometry=JSON.stringify(r.geometry)),r.renderingRule&&(r.renderingRule=JSON.stringify(r.renderingRule)),r.mosaicRule&&(r.mosaicRule=JSON.stringify(r.mosaicRule)),r.geometryType=r.geometryType||T.GEOMETRY_TYPE,r.pixelSize=r.pixelSize||T.PIXEL_SIZE,r.f=r.f||T.CONTENT_FORMAT,(0,m["default"])({url:e+"/computeHistograms",callbackParamName:"callback",timeout:T.TIMEOUT,content:r,handleAs:"json"},{usePost:!0})},B=function(e,r){var t=new d["default"],n=new c["default"](g.GEOMETRY_SERVICE_URL),a=new _["default"];return a.geometries=[e],a.distances=[r],a.unit=c["default"].UNIT_KILOMETER,a.outSpatialReference=new S["default"](102100),n.buffer(a,t.resolve,console.error),t},G=function(e){if(C)return C;C=new d["default"];var r={areaUnit:'{"areaUnit": "esriHectares"}',polygons:JSON.stringify([e]),calculationType:"geodesic",sr:102100,f:"json"};return(0,m["default"])({url:g.GEOMETRY_SERVICE_URL+"/areasAndLengths",callbackParamName:"callback",timeout:T.TIMEOUT,content:r,handleAs:"json"},{usePost:!0}).then(function(e){C.resolve(e.areas[0])}),C},x=function(e){var r=new d["default"],t={where:"ISO = 'IDN'",geometryType:T.GEOMETRY_POINT,geometry:JSON.stringify(e),returnGeometry:!1,outFields:[],f:"json"};return(0,m["default"])({url:g.BOUNDARY_SERVICE_URL+"/query",callbackParamName:"callback",timeout:T.TIMEOUT,content:t,handleAs:"json"},{usePost:!0}).then(function(e){r.resolve(e&&e.features&&e.features.length>0)}),r},X=function(e){if(P)return P;P=new d["default"];var r={geometry:e,pixelSize:T.PIXEL_SIZE,renderingRule:p.arithmetic(g.CANOPY_DENSITY_REMAP,g.TREE_COVER_LOSS.id,v.MULTIPLY)};return V(g.IMAGE_SERVICE_URL,r).then(function(e){P.resolve(y({histograms:e.histograms}))}),P},j=function(e){var r=new d["default"],t=new w(g.TREE_COVER_LOSS.bounds,g.PRIMARY_FOREST.bounds),n=t.getRule(g.TREE_COVER_LOSS.id,g.PRIMARY_FOREST.id),a={geometry:e,pixelSize:T.PIXEL_SIZE,renderingRule:n};return V(g.IMAGE_SERVICE_URL,a).then(function(e){for(var n=t.A,a=t.B,o=y({histograms:e.histograms,noSlice:!0}),i=[],s=0;s<n.length;s++){for(var u=0,R=0;R<a.length;R++){var E=t.encode(n[s],a[R]);u+=o[E]||0}i.push(u)}r.resolve(i)}),r},Z=function(e){var r=new d["default"],t=new w(g.TREE_COVER_LOSS.bounds,g.PEAT.bounds),n=t.getSimpleRule(g.TREE_COVER_LOSS.id,g.PEAT.id),a={geometry:e,pixelSize:T.PIXEL_SIZE,renderingRule:n};return V(g.IMAGE_SERVICE_URL,a).then(function(e){r.resolve(y({histograms:e.histograms}))}),r},H=function(e){var r=new d["default"],t=new w(g.TREE_COVER_LOSS.bounds,g.PROTECTED_AREA.bounds),n=t.getSimpleRule(g.TREE_COVER_LOSS.id,g.PROTECTED_AREA.id),a={geometry:e,pixelSize:T.PIXEL_SIZE,renderingRule:n};return V(g.IMAGE_SERVICE_URL,a).then(function(e){r.resolve(y({histograms:e.histograms}))}),r},$=function(e){var r=new d["default"],t=new w(g.TREE_COVER_LOSS.bounds,g.CARBON.bounds),n=t.getRule(g.TREE_COVER_LOSS.id,g.CARBON.remap),a={geometry:e,pixelSize:T.PIXEL_SIZE,renderingRule:n};return V(g.IMAGE_SERVICE_URL,a).then(function(e){for(var n=t.A,a=t.B,o=y({histograms:e.histograms,noSlice:!0}),i=[],s=0;s<n.length;s++){for(var u=0,R=1;R<a.length;R++){var E=t.encode(n[s],a[R]);u+=o[E]||0}i.push(u)}r.resolve(i)}),r},W=function(e,r){var t=new d["default"],n={geometry:r,pixelSize:T.PIXEL_SIZE,mosaicRule:p.mosaic(F(e))};return V(g.IMAGE_SERVICE_URL,n).then(function(e){if(e.histograms.length){var r=y({histograms:e.histograms});t.resolve(r.length?r[0]:0)}else t.resolve(0)},function(){t.resolve(0)}),t},J=function(e){var r=new d["default"],t={geometry:e,pixelSize:T.PIXEL_SIZE,renderingRule:p.remap(g.CARBON.id,[0,20,20,1e3],[0,1])};return V(g.IMAGE_SERVICE_URL,t).then(function(e){if(e.histograms.length){var t=y({histograms:e.histograms});r.resolve(t.length?t[0]:0)}else r.resolve(0)},function(){r.resolve(0)}),r},q=function(e){var r=new d["default"],t={geometry:e,pixelSize:g.FIRES.PIXEL_SIZE},n=f({},t,{mosaicRule:p.mosaic(g.FIRES.ID_09)}),a=f({},t,{mosaicRule:p.mosaic(g.FIRES.ID_10)}),o=f({},t,{mosaicRule:p.mosaic(g.FIRES.ID_11)}),i=f({},t,{mosaicRule:p.mosaic(g.FIRES.ID_12)});return(0,A["default"])([V(g.FIRES_RASTER_URL,n),V(g.FIRES_RASTER_URL,a),V(g.FIRES_RASTER_URL,o),V(g.FIRES_RASTER_URL,i)]).then(function(e){var t=e.map(function(e){var r=y({histograms:e.histograms,noSlice:!0});return r.reduce(function(e,r,t){return e+r*t},0)}),n=t.reduce(function(e,r){return e+r},0)/t.length;r.resolve(n)}),r},K=function(e){var r=new d["default"],t={geometry:e,pixelSize:g.FIRES.PIXEL_SIZE},n=f({},t,{mosaicRule:p.mosaic(g.FIRES.ID_13)}),a=f({},t,{mosaicRule:p.mosaic(g.FIRES.ID_14)}),o=f({},t,{mosaicRule:p.mosaic(g.FIRES.ID_15)});return(0,A["default"])([V(g.FIRES_RASTER_URL,n),V(g.FIRES_RASTER_URL,a),V(g.FIRES_RASTER_URL,o)]).then(function(e){var t=e.map(function(e){var r=y({histograms:e.histograms,noSlice:!0});return r.reduce(function(e,r,t){return e+r*t},0)}),n=t.reduce(function(e,r){return e+r},0)/t.length;r.resolve(n)}),r},Q=function(e){var r=new d["default"];return(0,A["default"])({AREA:G(e),LOSS:X(e),PRIMARY_FOREST:j(e),PEAT:Z(e),PROTECTED_AREA:H(e),CARBON:$(e),FIRE:q(e)}).then(function(e){var t=b(e.LOSS)/1e3,n=M(e.PRIMARY_FOREST)/1e3,a=M(e.PEAT)/1e3,o=M(e.PROTECTED_AREA)/1e3,i=M(e.CARBON)/1e3,s=e.FIRE/e.AREA*1e3,u=t?N(k(t,h.TREE_COVER_LOSS_RATE.mean,h.TREE_COVER_LOSS_RATE.std_dev)):D(),R=n?N(k(n,h.PRIMARY_FOREST_LOSS.mean,h.PRIMARY_FOREST_LOSS.std_dev)):D(),E=a?N(k(a,h.PEAT_LOSS.mean,h.PEAT_LOSS.std_dev)):D(),_=o?N(k(o,h.WDPA_LOSS.mean,h.WDPA_LOSS.std_dev)):D(),c=i?N(k(i,h.CARBON_LOSS.mean,h.CARBON_LOSS.std_dev)):D(),S=s?N(k(s,h.FIRE_ACTIVITY_HISTORIC.mean,h.FIRE_ACTIVITY_HISTORIC.std_dev)):D();r.resolve({primary_forest:f({amount:n},R),peat:f({amount:a},E),protected_areas:f({amount:o},_),carbon:f({amount:i},c),tree_cover:f({amount:t},u),fire:f({amount:s},S)})}),r},ee=function(e){var r=new d["default"];return(0,A["default"])({AREA:G(e),LOSS_RATE:X(e),PRIMARY_FOREST:W(g.PRIMARY_FOREST.id,e),PEAT:W(g.PEAT.id,e),PROTECTED_AREA:W(g.PROTECTED_AREA.id,e),CARBON:J(e),IFL:W(g.INTACT_FOREST_LANDSCAPE.id,e),FIRE:K(e)}).then(function(e){var t=z(e.LOSS_RATE,T.FUTURE_YEAR_COUNT),n=U(L?e.PRIMARY_FOREST:e.IFL,e.AREA),a=U(e.PEAT,e.AREA),o=U(e.PROTECTED_AREA,e.AREA),i=U(e.CARBON,e.AREA),s=e.FIRE/e.AREA*1e3,u=n?N(k(n,h.PRIMARY_FOREST_AREA.mean,h.PRIMARY_FOREST_AREA.std_dev)):D(),R=a?N(k(a,h.PEAT_AREA.mean,h.PEAT_AREA.std_dev)):D(),E=o?N(k(o,h.WDPA_AREA.mean,h.WDPA_AREA.std_dev)):D(),_=i?N(k(i,h.CARBON_AREA.mean,h.CARBON_AREA.std_dev)):D(),c=t?N(k(t,h.TREE_COVER_FUTURE_RATE.mean,h.TREE_COVER_FUTURE_RATE.std_dev)):D(),S=s?N(k(s,h.FIRE_ACTIVITY_FUTURE.mean,h.FIRE_ACTIVITY_FUTURE.std_dev)):D();r.resolve({primary_forest:f({amount:n},u),peat:f({amount:a},R),protected_areas:f({amount:o},E),carbon:f({amount:i},_),tree_cover:f({amount:t},c),fire:f({amount:s},S)})}),r},re=function(e,r){var t=e.HISTORIC,n=e.FUTURE,a=0===n.tree_cover.zScore&&0===t.tree_cover.zScore,o=0===n.primary_forest.zScore&&0===t.primary_forest.zScore,i=0===n.peat.zScore&&0===t.peat.zScore,s=0===n.protected_areas.zScore&&0===t.protected_areas.zScore,u=0===n.carbon.zScore&&0===t.carbon.zScore,R=0===n.fire.zScore&&0===t.fire.zScore,E=(t.tree_cover.zScore+t.primary_forest.zScore+t.peat.zScore+t.protected_areas.zScore+t.carbon.zScore+t.fire.zScore)/6,_=(n.tree_cover.zScore+n.primary_forest.zScore+n.peat.zScore+n.protected_areas.zScore+n.carbon.zScore+n.fire.zScore)/6,c=N(E),S=N(_);return{tree_cover:{extent:{amount:n.tree_cover.amount,rank:n.tree_cover.rank},loss:{amount:t.tree_cover.amount,rank:t.tree_cover.rank},risk:a?D().rank:N((n.tree_cover.zScore+t.tree_cover.zScore)/2).rank},primary_forest:{extent:{amount:n.primary_forest.amount,rank:n.primary_forest.rank},loss:{amount:t.primary_forest.amount,rank:t.primary_forest.rank},risk:o?D().rank:N((n.primary_forest.zScore+t.primary_forest.zScore)/2).rank},peat:{extent:{amount:n.peat.amount,rank:n.peat.rank},loss:{amount:t.peat.amount,rank:t.peat.rank},risk:i?D().rank:N((n.peat.zScore+t.peat.zScore)/2).rank},protected_areas:{extent:{amount:n.protected_areas.amount,rank:n.protected_areas.rank},loss:{amount:t.protected_areas.amount,rank:t.protected_areas.rank},risk:s?D().rank:N((n.protected_areas.zScore+t.protected_areas.zScore)/2).rank},carbon:{extent:{amount:n.carbon.amount,rank:n.carbon.rank},loss:{amount:t.carbon.amount,rank:t.carbon.rank},risk:u?D().rank:N((n.carbon.zScore+t.carbon.zScore)/2).rank},fire:{extent:{amount:n.fire.amount,rank:n.fire.rank},loss:{amount:t.fire.amount,rank:t.fire.rank},risk:R?D().rank:N((n.fire.zScore+t.fire.zScore)/2).rank},historic_loss:c.rank,future_risk:S.rank,priority_level:Y(c.score,S.score),mill_name:r||""}}});