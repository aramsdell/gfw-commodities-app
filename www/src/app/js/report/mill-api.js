define(["exports","esri/tasks/BufferParameters","esri/tasks/GeometryService","esri/SpatialReference","esri/geometry/Polygon","esri/request","esri/config","dojo/Deferred","dojo/promise/all"],function(e,r,t,n,o,a,i,u,s){"use strict";function R(e){return e&&e.__esModule?e:{"default":e}}function E(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _(e,r,t){var n=new A["default"];return(0,I["default"])({BUFFER:X(e,t||v.RADIUS),INDO:G(e)}).then(function(t){var o=t.BUFFER[0];C=t.INDO,(0,I["default"])({HISTORIC:te(o),FUTURE:ne(o)}).then(function(t){n.resolve(oe(t,e,r))})}),n}Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=_;var c=R(r),S=R(t),l=R(n),m=R(o),d=R(a),f=R(i),A=R(u),I=R(s),T=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},O=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),v={RADIUS:50,DENSITY:30,TIMEOUT:45e3,PIXEL_SIZE:100,FUTURE_YEAR_COUNT:2,CONTENT_FORMAT:"json",HISTORIC_YEAR_END_INDEX:11,HISTORIC_YEAR_START_INDEX:8,GEOMETRY_POINT:"esriGeometryPoint",GEOMETRY_POLYGON:"esriGeometryPolygon"},g={1:"low",2:"medium low",3:"medium",4:"medium high",5:"high"},p={ADD:1,MULTIPLY:3},h={mosaic:function(e){return{mosaicMethod:"esriMosaicLockRaster",mosaicOperation:"MT_FIRST",lockRasterIds:[e],ascending:!0}},arithmetic:function(e,r,t){return{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:e,Raster2:r,Operation:t}}},remap:function(e,r,t){return{rasterFunction:"Remap",rasterFunctionArguments:{InputRanges:r,OutputValues:t,Raster:e,AllowUnmatched:!1}}}},P={FIRES_RASTER_URL:"http://gis-gfw.wri.org/arcgis/rest/services/image_services/annual_fires/ImageServer",IMAGE_SERVICE_URL:"http://gis-gfw.wri.org/arcgis/rest/services/image_services/analysis/ImageServer",GEOMETRY_SERVICE_URL:"http://gis-gfw.wri.org/arcgis/rest/services/Utilities/Geometry/GeometryServer",BOUNDARY_SERVICE_URL:"http://gis-potico.wri.org/arcgis/rest/services/CommoditiesAnalyzer/mapfeatures/MapServer/6",CANOPY_DENSITY_REMAP:h.remap("$520",[0,v.DENSITY,v.DENSITY,101],[0,1]),TREE_COVER_LOSS:{id:"$530",bounds:[1,14]},PRIMARY_FOREST:{id:"$519",bounds:[1,2]},PEAT:{id:"$8",bounds:[0,1]},PROTECTED_AREA:{id:"$10",bounds:[0,1]},CARBON:{id:"$524",bounds:[0,1],remap:h.remap("$524",[0,21,21,1e3],[0,1])},TREE_COVER_EXTENT:{id:"$520"},INTACT_FOREST_LANDSCAPE:{id:"$9"},FIRES:{PIXEL_SIZE:890.5559263,ID_09:1,ID_10:2,ID_11:3,ID_12:4,ID_13:5,ID_14:6,ID_15:7}},L={CARBON_AREA:{type:"percent",mean:97.67173618,std_dev:5.775175366},CARBON_LOSS:{type:"number",mean:55479.66071,std_dev:31676.19725},FIRE_ACTIVITY_FUTURE:{type:"number",mean:463888e-9,std_dev:781948e-9},FIRE_ACTIVITY_HISTORIC:{type:"number",mean:287583e-9,std_dev:336257e-9},WDPA_AREA:{type:"percent",mean:7.228910262,std_dev:8.985175562},WDPA_LOSS:{type:"number",mean:1119.288265,std_dev:2797.828324},PEAT_AREA:{type:"percent",mean:9.817356171,std_dev:12.76025748},PEAT_LOSS:{type:"number",mean:10890.62372,std_dev:19728.76226},PRIMARY_FOREST_AREA:{type:"percent",mean:12.5132604,std_dev:16.9831375},PRIMARY_FOREST_LOSS:{type:"number",mean:11965.28699,std_dev:22059.03368},TREE_COVER_FUTURE_RATE:{type:"number",mean:9321.90051,std_dev:4551.812568},TREE_COVER_LOSS_RATE:{type:"number",mean:13952.03571,std_dev:7912.007913}},C=void 0,y=new S["default"](P.GEOMETRY_SERVICE_URL);f["default"].defaults.io.corsEnabledServers.push("gis-gfw.wri.org"),f["default"].defaults.io.corsEnabledServers.push("gis-potico.wri.org");var F=function(e){var r=e.histograms,t=e.noSlice,n=r&&1===r.length?r[0].counts:[];return t?n:n.slice(1)},U=function(e){return parseInt(e.replace(/\$/,""))},N=function(e,r){var t=e/r*100;return t>100?100:t},k=function(e,r,t){return(e-r)/t},Y=function(e){var r=void 0;return r=e>=1?5:e>=.5&&.99>=e?4:e>=-.49&&.49>=e?3:e>=-.99&&-.49>=e?2:1,{score:r,zScore:e,rank:g[r]}},D=function(){return{score:1,zScore:-1,rank:g[1]}},M=function(e,r){var t=e*r,n=void 0;return n=t>=21?5:t>=16&&20>=t?4:t>=11&&15>=t?3:t>=5&&10>=t?2:1,g[n]},b=function(e){for(var r=0,t=v.HISTORIC_YEAR_START_INDEX;t<=v.HISTORIC_YEAR_END_INDEX;t++)e[t]&&(r+=e[t]);return r},z=function(e){for(var r=[],t=v.FUTURE_YEAR_COUNT;t>0;t--)r.push(e[e.length-t]);return r.reduce(function(e,r){return e+r},0)/r.length},w=function(e){for(var r=[],t=v.HISTORIC_YEAR_START_INDEX;t<=v.HISTORIC_YEAR_END_INDEX;t++)r.push(e[t]);return r.reduce(function(e,r){return e+r},0)/r.length},V=function(){function e(r,t){E(this,e),this.fromBounds=function(e){for(var r=[],t=e[1],n=e[0];t>=n;n++)r.push(n);return r},this.A=this.fromBounds(r),this.B=this.fromBounds(t)}return O(e,[{key:"encode",value:function(e,r){return this.B.length*e+r}},{key:"decode",value:function(e){var r=e%this.B.length,t=(e-r)/this.B.length;return[t,r]}},{key:"getSimpleRule",value:function(e,r){var t=P.CANOPY_DENSITY_REMAP,n=h.arithmetic(t,h.arithmetic(e,r,p.MULTIPLY),p.MULTIPLY);return n.rasterFunctionArguments.Raster2.outputPixelType="U8",n}},{key:"getRule",value:function(e,r){var t=h.remap(e,[this.A[0],this.A[this.A.length-1]+1],[this.B.length]),n=P.CANOPY_DENSITY_REMAP,o=h.arithmetic(n,h.arithmetic(h.arithmetic(t,e,p.MULTIPLY),r,p.ADD),p.MULTIPLY);return o.rasterFunctionArguments.Raster2.outputPixelType="U8",o}}]),e}(),B=function(e,r){return r.geometry&&(r.geometry=JSON.stringify(r.geometry)),r.renderingRule&&(r.renderingRule=JSON.stringify(r.renderingRule)),r.mosaicRule&&(r.mosaicRule=JSON.stringify(r.mosaicRule)),r.geometryType=r.geometryType||v.GEOMETRY_POLYGON,r.pixelSize=r.pixelSize||v.PIXEL_SIZE,r.f=r.f||v.CONTENT_FORMAT,(0,d["default"])({url:e+"/computeHistograms",callbackParamName:"callback",timeout:v.TIMEOUT,content:r,handleAs:"json"},{usePost:!0})},G=function(e){var r=new A["default"],t={where:"ISO = 'IDN'",geometryType:v.GEOMETRY_POINT,geometry:JSON.stringify(e),returnGeometry:!1,outFields:[],f:"json"};return(0,d["default"])({url:P.BOUNDARY_SERVICE_URL+"/query",callbackParamName:"callback",timeout:v.TIMEOUT,content:t,handleAs:"json"},{usePost:!0}).then(function(e){r.resolve(e&&e.features&&e.features.length>0)}),r},x=function(e){var r=new A["default"],t={geometryType:v.GEOMETRY_POLYGON,spatialRel:"esriSpatialRelIntersects",geometry:JSON.stringify(e),returnGeometry:!0,outFields:[],outSR:54010,f:"json"};return(0,d["default"])({url:P.BOUNDARY_SERVICE_URL+"/query",callbackParamName:"callback",timeout:v.TIMEOUT,content:t,handleAs:"json"},{usePost:!0}).then(function(e){r.resolve(e.features)}),r},X=function(e,r){var t=new A["default"],n=new c["default"];return n.geometries=[e],n.distances=[r],n.unit=S["default"].UNIT_KILOMETER,n.outSpatialReference=new l["default"](54010),y.buffer(n,t.resolve,console.error),t},j=function(e,r){var t=new A["default"];return y.intersect(e,r,t.resolve,console.error),t},H=function(e){var r=new A["default"],t={areaUnit:'{"areaUnit": "esriHectares"}',calculationType:"preserveShape",sr:54010,f:"json"};return x(e).then(function(n){var o=n.map(function(e){return new m["default"](e.geometry)});j(o,e).then(function(e){t.polygons=JSON.stringify(e),(0,d["default"])({url:P.GEOMETRY_SERVICE_URL+"/areasAndLengths",callbackParamName:"callback",timeout:v.TIMEOUT,content:t,handleAs:"json"},{usePost:!0}).then(function(e){r.resolve(e.areas.reduce(function(e,r){return e+r},0))})})}),r},Z=function(e){var r=new A["default"],t={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:h.arithmetic(P.CANOPY_DENSITY_REMAP,P.TREE_COVER_LOSS.id,p.MULTIPLY)};return B(P.IMAGE_SERVICE_URL,t).then(function(e){r.resolve(F({histograms:e.histograms}))}),r},$=function(e){var r=new A["default"],t=new V(P.TREE_COVER_LOSS.bounds,P.PRIMARY_FOREST.bounds),n=t.getRule(P.TREE_COVER_LOSS.id,P.PRIMARY_FOREST.id),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return B(P.IMAGE_SERVICE_URL,o).then(function(e){for(var n=t.A,o=t.B,a=F({histograms:e.histograms,noSlice:!0}),i=[],u=0;u<n.length;u++){for(var s=0,R=0;R<o.length;R++){var E=t.encode(n[u],o[R]);s+=a[E]||0}i.push(s)}r.resolve(i)}),r},J=function(e){var r=new A["default"],t=new V(P.TREE_COVER_LOSS.bounds,P.PEAT.bounds),n=t.getSimpleRule(P.TREE_COVER_LOSS.id,P.PEAT.id),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return B(P.IMAGE_SERVICE_URL,o).then(function(e){r.resolve(F({histograms:e.histograms}))}),r},W=function(e){var r=new A["default"],t=new V(P.TREE_COVER_LOSS.bounds,P.PROTECTED_AREA.bounds),n=t.getSimpleRule(P.TREE_COVER_LOSS.id,P.PROTECTED_AREA.id),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return B(P.IMAGE_SERVICE_URL,o).then(function(e){r.resolve(F({histograms:e.histograms}))}),r},q=function(e){var r=new A["default"],t=new V(P.TREE_COVER_LOSS.bounds,P.CARBON.bounds),n=t.getRule(P.TREE_COVER_LOSS.id,P.CARBON.remap),o={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:n};return B(P.IMAGE_SERVICE_URL,o).then(function(e){for(var n=t.A,o=t.B,a=F({histograms:e.histograms,noSlice:!0}),i=[],u=0;u<n.length;u++){for(var s=0,R=1;R<o.length;R++){var E=t.encode(n[u],o[R]);s+=a[E]||0}i.push(s)}r.resolve(i)}),r},K=function(e,r){var t=new A["default"],n={geometry:r,pixelSize:v.PIXEL_SIZE,mosaicRule:h.mosaic(U(e))};return B(P.IMAGE_SERVICE_URL,n).then(function(e){if(e.histograms.length){var r=F({histograms:e.histograms});t.resolve(r.length?r.reduce(function(e,r){return e+r},0):0)}else t.resolve(0)},function(){t.resolve(0)}),t},Q=function(e){var r=new A["default"],t={geometry:e,pixelSize:v.PIXEL_SIZE,renderingRule:P.CARBON.remap};return B(P.IMAGE_SERVICE_URL,t).then(function(e){if(e.histograms.length){var t=F({histograms:e.histograms});r.resolve(t.length?t[0]:0)}else r.resolve(0)},function(){r.resolve(0)}),r},ee=function(e){var r=new A["default"],t={geometry:e,pixelSize:P.FIRES.PIXEL_SIZE},n=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_09)}),o=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_10)}),a=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_11)}),i=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_12)});return(0,I["default"])([B(P.FIRES_RASTER_URL,n),B(P.FIRES_RASTER_URL,o),B(P.FIRES_RASTER_URL,a),B(P.FIRES_RASTER_URL,i)]).then(function(e){var t=e.map(function(e){var r=F({histograms:e.histograms,noSlice:!0});return r.reduce(function(e,r,t){return e+r*t},0)});r.resolve(t.reduce(function(e,r){return e+r},0)/t.length)}),r},re=function(e){var r=new A["default"],t={geometry:e,pixelSize:P.FIRES.PIXEL_SIZE},n=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_13)}),o=T({},t,{mosaicRule:h.mosaic(P.FIRES.ID_14)});return(0,I["default"])([B(P.FIRES_RASTER_URL,n),B(P.FIRES_RASTER_URL,o)]).then(function(e){var t=e.map(function(e){var r=F({histograms:e.histograms,noSlice:!0});return r.reduce(function(e,r,t){return e+r*t},0)});r.resolve(t.reduce(function(e,r){return e+r},0)/t.length)}),r},te=function(e){var r=new A["default"];return(0,I["default"])({AREA:H(e),LOSS:Z(e),PRIMARY_FOREST:$(e),PEAT:J(e),PROTECTED_AREA:W(e),CARBON:q(e),FIRE:ee(e)}).then(function(e){var t=w(e.LOSS),n=b(e.PRIMARY_FOREST),o=b(e.PEAT),a=b(e.PROTECTED_AREA),i=b(e.CARBON),u=e.FIRE/e.AREA,s=t?Y(k(t,L.TREE_COVER_LOSS_RATE.mean,L.TREE_COVER_LOSS_RATE.std_dev)):D(),R=n?Y(k(n,L.PRIMARY_FOREST_LOSS.mean,L.PRIMARY_FOREST_LOSS.std_dev)):D(),E=o?Y(k(o,L.PEAT_LOSS.mean,L.PEAT_LOSS.std_dev)):D(),_=a?Y(k(a,L.WDPA_LOSS.mean,L.WDPA_LOSS.std_dev)):D(),c=i?Y(k(i,L.CARBON_LOSS.mean,L.CARBON_LOSS.std_dev)):D(),S=u?Y(k(u,L.FIRE_ACTIVITY_HISTORIC.mean,L.FIRE_ACTIVITY_HISTORIC.std_dev)):D();r.resolve({primary_forest:T({amount:n},R),peat:T({amount:o},E),protected_areas:T({amount:a},_),carbon:T({amount:i},c),tree_cover:T({amount:t},s),fire:T({amount:u},S)})}),r},ne=function(e){var r=new A["default"];return(0,I["default"])({AREA:H(e),LOSS_RATE:Z(e),PRIMARY_FOREST:K(P.PRIMARY_FOREST.id,e),PEAT:K(P.PEAT.id,e),PROTECTED_AREA:K(P.PROTECTED_AREA.id,e),CARBON:Q(e),IFL:K(P.INTACT_FOREST_LANDSCAPE.id,e),FIRE:re(e)}).then(function(e){var t=z(e.LOSS_RATE,v.FUTURE_YEAR_COUNT),n=N(C?e.PRIMARY_FOREST:e.IFL,e.AREA),o=N(e.PEAT,e.AREA),a=N(e.PROTECTED_AREA,e.AREA),i=N(e.CARBON,e.AREA),u=e.FIRE/e.AREA,s=n?Y(k(n,L.PRIMARY_FOREST_AREA.mean,L.PRIMARY_FOREST_AREA.std_dev)):D(),R=o?Y(k(o,L.PEAT_AREA.mean,L.PEAT_AREA.std_dev)):D(),E=a?Y(k(a,L.WDPA_AREA.mean,L.WDPA_AREA.std_dev)):D(),_=i?Y(k(i,L.CARBON_AREA.mean,L.CARBON_AREA.std_dev)):D(),c=t?Y(k(t,L.TREE_COVER_FUTURE_RATE.mean,L.TREE_COVER_FUTURE_RATE.std_dev)):D(),S=u?Y(k(u,L.FIRE_ACTIVITY_FUTURE.mean,L.FIRE_ACTIVITY_FUTURE.std_dev)):D();r.resolve({primary_forest:T({amount:n},s),peat:T({amount:o},R),protected_areas:T({amount:a},E),carbon:T({amount:i},_),tree_cover:T({amount:t},c),fire:T({amount:u},S)})}),r},oe=function(e,r,t){var n=e.HISTORIC,o=e.FUTURE,a=0===o.tree_cover.zScore&&0===n.tree_cover.zScore,i=0===o.primary_forest.zScore&&0===n.primary_forest.zScore,u=0===o.peat.zScore&&0===n.peat.zScore,s=0===o.protected_areas.zScore&&0===n.protected_areas.zScore,R=0===o.carbon.zScore&&0===n.carbon.zScore,E=0===o.fire.zScore&&0===n.fire.zScore,_=(n.tree_cover.zScore+n.primary_forest.zScore+n.peat.zScore+n.protected_areas.zScore+n.carbon.zScore+n.fire.zScore)/6,c=(o.tree_cover.zScore+o.primary_forest.zScore+o.peat.zScore+o.protected_areas.zScore+o.carbon.zScore+o.fire.zScore)/6,S=Y(_),l=Y(c),m={};return r.getLatitude&&(m.latitude=r.getLatitude().toFixed(4)),r.getLongitude&&(m.longitude=r.getLongitude().toFixed(4)),T({tree_cover:{extent:{amount:o.tree_cover.amount,rank:o.tree_cover.rank},loss:{amount:n.tree_cover.amount,rank:n.tree_cover.rank},risk:a?D().rank:Y((o.tree_cover.zScore+n.tree_cover.zScore)/2).rank},primary_forest:{extent:{amount:o.primary_forest.amount,rank:o.primary_forest.rank},loss:{amount:n.primary_forest.amount,rank:n.primary_forest.rank},risk:i?D().rank:Y((o.primary_forest.zScore+n.primary_forest.zScore)/2).rank},peat:{extent:{amount:o.peat.amount,rank:o.peat.rank},loss:{amount:n.peat.amount,rank:n.peat.rank},risk:u?D().rank:Y((o.peat.zScore+n.peat.zScore)/2).rank},protected_areas:{extent:{amount:o.protected_areas.amount,rank:o.protected_areas.rank},loss:{amount:n.protected_areas.amount,rank:n.protected_areas.rank},risk:s?D().rank:Y((o.protected_areas.zScore+n.protected_areas.zScore)/2).rank},carbon:{extent:{amount:o.carbon.amount,rank:o.carbon.rank},loss:{amount:n.carbon.amount,rank:n.carbon.rank},risk:R?D().rank:Y((o.carbon.zScore+n.carbon.zScore)/2).rank},fire:{extent:{amount:o.fire.amount,rank:o.fire.rank},loss:{amount:n.fire.amount,rank:n.fire.rank},risk:E?D().rank:Y((o.fire.zScore+n.fire.zScore)/2).rank},historic_loss:S.rank,future_risk:l.rank,priority_level:M(S.score,l.score),mill_name:t||""},m)}});